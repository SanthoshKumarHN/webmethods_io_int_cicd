# Export workflow pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger: none
parameters:
  projectName: ''
  source_environment: ''
  workflowId: ''
pool:
  vmImage: ubuntu-latest

steps:
- bash: |
    if [ -z "$PROJECTNAME" ]; then
      echo "##vso[task.logissue type=error;]Missing template parameter \"Project name\""
      echo "##vso[task.complete result=Failed;]"
    fi
    if [ -z "$SOURCE_ENVIRONMENT" ]; then
      echo "##vso[task.logissue type=error;]Missing template parameter \"source_environment\""
      echo "##vso[task.complete result=Failed;]"
    fi
    if [ -z "$WORKFLOWID" ]; then
      echo "##vso[task.logissue type=error;]Missing template parameter \"Workflow ID\""
      echo "##vso[task.complete result=Failed;]"
    fi
  env:
    APIPROJECT: ${{parameters.projectName}}
    SOURCE_ENVIRONMENT: ${{parameters.source_environment}}
    APIID: ${{parameters.workflowId}}
  displayName: Check for required parameters

- bash: |
    echo "##vso[task.setvariable variable=source_environment_hostname]`yq -e ".tenant.hostname" configs/${{parameters.source_environment}}`"
    echo "##vso[task.setvariable variable=source_environment_port]`yq -e ".tenant.port" configs/${{parameters.source_environment}}`"
    echo "##vso[task.setvariable variable=exporter_user]`yq -e ".tenant.exporter_username" configs/${{parameters.source_environment}}`"
    echo "##vso[task.setvariable variable=source_type]`yq -e ".tenant.type" configs/${{parameters.source_environment}}`"
    echo "##vso[build.updatebuildnumber]$(Build.BuildNumber)-$(projectName)"
    echo $(System.DefaultWorkingDirectory)
  workingDirectory: '$(System.DefaultWorkingDirectory)'
  displayName: 'Get Environment Tenant Details'

- script: |
    echo ${PROJECTNAME}
    echo ${WORKFLOWID}
    echo ${LOCAL_DEV_URL}
    EXPORT_URL=${LOCAL_DEV_URL}/apis/v1/rest/projects/:project/workflows/:workflow/export
    echo ${EXPORT_URL}
    echo ${PWD}
=======
  displayName: 'Export Workflow'

- script: |
    echo Add other tasks to build, test, and deploy your project.
    echo See https://aka.ms/yaml
  displayName: 'Run a multi-line script'
